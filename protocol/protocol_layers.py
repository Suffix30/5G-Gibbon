#!/usr/bin/env python3
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from scapy.all import Packet, ByteField, ShortField, IntField, XByteField, XIntField, StrLenField, FieldLenField, BitField
import struct
 
class PFCPHeader(Packet):
    name = "PFCP Header"
    fields_desc = [
        BitField("version", 1, 3),
        BitField("spare", 0, 3),
        BitField("mp", 0, 1),
        BitField("s", 1, 1),
        XByteField("message_type", 1),
        ShortField("length", None),
        XIntField("seid", 0),
        IntField("sequence", 0)
    ]
    
    def post_build(self, p, pay):
        if self.length is None:
            l = len(p) + len(pay) - 4
            p = p[:2] + struct.pack("!H", l) + p[4:]
        return p + pay

class NGAPHeader(Packet):
    name = "NGAP Header"
    fields_desc = [
        ByteField("procedure_code", 21),
        ByteField("criticality", 0),
        FieldLenField("length", None, length_of="value", fmt="B"),
        StrLenField("value", b"", length_from=lambda pkt: pkt.length)
    ]

def craft_ngap_setup_request():
    ngap_payload = bytes([
        0x00, 0x15, 0x00, 0x32, 0x00, 0x00, 0x04, 0x00,
        0x1b, 0x00, 0x08, 0x00, 0x00, 0xf1, 0x10, 0x00,
        0x00, 0x00, 0x08, 0x00, 0x52, 0x40, 0x0a, 0x03,
        0x80, 0x65, 0x6e, 0x62, 0x30, 0x31, 0x00, 0x00,
        0x66, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x00, 0x07,
        0x00, 0x00, 0xf1, 0x10, 0x00, 0x00, 0x00, 0x08,
        0x00, 0x15, 0x40, 0x01, 0x60
    ])
    return ngap_payload

def craft_pfcp_session_establishment():
    pfcp_payload = bytes([
        0x21, 0x32, 0x00, 0x2c, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x3c, 0x00, 0x01,
        0x00, 0x00, 0x02, 0x00, 0x02, 0x00, 0x00, 0x00,
        0x13, 0x00, 0x08, 0x00, 0x01, 0xc0, 0xa8, 0x01,
        0x64, 0x00, 0x00, 0x00, 0x38, 0x00, 0x0c, 0x00,
        0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00
    ])
    return pfcp_payload
